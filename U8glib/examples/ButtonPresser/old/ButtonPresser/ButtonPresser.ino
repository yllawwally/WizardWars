#include "U8glib.h"
//old not good version


U8GLIB_SSD1306_128X64 u8g(U8G_I2C_OPT_NO_ACK);  // Display which does not send AC


const int Stop = A3;
const int Play = A0;
const int Plus = A1;
const int Minus = A2;
const int Relay_1 = 14;
const int Relay_2 = 16;
const int PowerPlus = 15;


int State = 0;
int Timer = 0;
int LogoTimer = 0;
int Left_Speed = 50;
int Right_Speed = 50;
int Relay_1_State = 0;
int Relay_2_State = 0;
int Relay_1_Current = 0;
int Relay_2_Current = 0;
int Relay_1_Press_Time = 5;
int Relay_2_Press_Time = 5;
int in1 = 10;
int in2 = 9;


const unsigned char  gli_logo_new_bits[] PROGMEM = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x1f, 0x00, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff,
   0x7f, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0x00, 0xfc, 0xff, 0xff, 0xff, 0x01, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x07, 0x00, 0xff, 0x01, 0x00, 0xf8, 0x03, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x1f, 0x80, 0x7f, 0x00, 0x00,
   0xe0, 0x0f, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x60, 0x30,
   0xc0, 0x1f, 0x00, 0x00, 0xc0, 0x1f, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x30, 0x6f, 0xe0, 0x0f, 0x00, 0x00, 0x80, 0x3f, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x30, 0x49, 0xf0, 0x07, 0x00, 0x00,
   0x00, 0x7f, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x18, 0xc9,
   0xf8, 0x03, 0x00, 0x00, 0x00, 0x7e, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x18, 0xcf, 0xf8, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x10, 0xc5, 0xfc, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x30, 0x6d,
   0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x60, 0x30, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x3f, 0xff, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x0f,
   0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x02, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x7f, 0x00, 0x00, 0xfc,
   0xff, 0xff, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x00, 0x7f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00,
   0x00, 0xf8, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0xff, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00,
   0x00, 0xfc, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0xfc, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x00, 0xf8, 0x01, 0x00, 0x00, 0x00, 0xfc, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0xf8, 0x03, 0x00, 0x00,
   0x00, 0xfe, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0xf0, 0x03, 0x00, 0x00, 0x00, 0xff, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x00, 0xe0, 0x0f, 0x00, 0x00, 0x80, 0xff, 0x00, 0xe0,
   0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0xc0, 0x1f, 0x00, 0x00,
   0xc0, 0xff, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0x00, 0x7f, 0x00, 0x00, 0xf8, 0xfb, 0x00, 0xe0, 0x0f, 0x00, 0x00, 0x00,
   0x00, 0x3f, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xf1, 0x00, 0xe0,
   0xff, 0xff, 0xff, 0x3f, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff,
   0x3f, 0xf0, 0x00, 0xe0, 0xff, 0xff, 0xff, 0x3f, 0x00, 0x3f, 0x00, 0x00,
   0x00, 0xe0, 0xff, 0xff, 0x0f, 0xf0, 0x00, 0xe0, 0xff, 0xff, 0xff, 0x3f,
   0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x7f, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };





void u8g_prepare(void) {
  u8g.setFont(u8g_font_6x10);
  u8g.setFontRefHeightExtendedText();
  u8g.setDefaultForegroundColor();
  u8g.setFontPosTop();
}







int TPS(int Speed_Value){//Relay Ticks per second Speed_Value is number of Relay Ticks

//Equation for ticks per second
//y = -0.002817507 + (4.934693 - -0.002817507)/(1 + (x/17.8861)^1.140085)
return (int)(24*(-10.143 + (17754.75)/(1 + pow((Speed_Value/17.8861),1.140085))));
  
}



uint8_t draw_state = 0;

void draw(void) {
  u8g_prepare();
enum {BufSize=4}; // If a is short use a smaller number, eg 5 or 6 
char buf[BufSize];

int TPS_Left;
int TPS_Right;
int Left_Zone=0;
int Right_Zone=0;

  switch (draw_state){
    case 0 :

      //  u8g.drawXBMP( 0, 0, 16, 39, gli_logo_new_bits);
        u8g.drawBitmapP( 0, 12, 16, 39, gli_logo_new_bits);
        
        break;
    case 1 : 
u8g.drawFrame(5,10,40,40);
u8g.drawFrame(6,11,38,38);
u8g.drawFrame(7,12,36,36);
u8g.drawFrame(50,10,40,40);
        break;
    case 2 :
u8g.drawFrame(51,11,38,38);
u8g.drawFrame(52,12,36,36);
u8g.drawFrame(50,10,40,40);
    break;
    default :
u8g.setFont(u8g_font_helvB14);
snprintf (buf, BufSize, "%d", Timer);
u8g.drawStr(20, 45, buf);//Draw Left Speed
  break;
    }


if ((draw_state==1)||(draw_state==2)){    
u8g.drawStr(7, 10, "Relay 1");
u8g.drawStr(7+45, 10, "Relay 2");
u8g.setFont(u8g_font_helvB14);
TPS_Left = Left_Speed;
if (TPS_Left > 24){//switch per day to per hour
    TPS_Left = TPS_Left / 24;
    Left_Zone ++;
}
if (TPS_Left > 60){//switch per hour to per minute
    TPS_Left = TPS_Left / 60;
    Left_Zone ++;
}
if (TPS_Left > 60){//switch per minute to per second
    TPS_Left = TPS_Left / 60;
    Left_Zone ++;
  }
TPS_Right = Right_Speed;
if (TPS_Right > 25){//switch per day to per hour
    TPS_Right = TPS_Right / 24;
        Right_Zone ++;
  }
if (TPS_Right > 60){//switch per hour to per minute
    TPS_Right = TPS_Right / 60;
        Right_Zone ++;}
if (TPS_Right > 60){//switch per minute to per second
    TPS_Right = TPS_Right / 60;
        Right_Zone ++;
  }
snprintf (buf, BufSize, "%d", TPS_Left);
u8g.drawStr(20, 45, buf);//Draw Left Speed
snprintf (buf, BufSize, "%d", TPS_Right);
u8g.drawStr(60, 45, buf);//Draw Right Speed
u8g.setFont(u8g_font_6x10);

u8g.drawStr(10, 55, " per");
switch (Left_Zone){
  case 0 :
      u8g.drawStr(10, 65, "Day");
      break;
  case 1 :
      u8g.drawStr(10, 65, "Hour");
      break;
  case 2 :
       u8g.drawStr(10, 65, "Minute");
       break;
  case 3 :        
       u8g.drawStr(10, 65, "Second");
       break;
}
    
u8g.drawStr(10+45, 55, " per");
switch (Right_Zone){
  case 0 :
      u8g.drawStr(10+45, 65, "Day");
      break;
  case 1 :
      u8g.drawStr(10+45, 65, "Hour");
      break;
  case 2 :
       u8g.drawStr(10+45, 65, "Minute");
       break;
  case 3 :        
       u8g.drawStr(10+45, 65, "Second");
       break;
}
}
//Equation for ticks per second
//y = -0.002817507 + (4.934693 - -0.002817507)/(1 + (x/17.8861)^1.140085)


//Menu

u8g.setFont(u8g_font_6x10);
u8g.drawFrame(92,8,8,8);
u8g.drawFrame(93,9,6,6);
u8g.drawStr(102, 18, "Next");

u8g.drawLine(92,23,100,28);
u8g.drawLine(92,33,100,28);
u8g.drawLine(92,23,92,35);
u8g.drawStr(102, 33, "Start");

u8g.drawLine(92,43,100,43);
u8g.drawLine(92,42,100,42);
u8g.drawLine(95,38,95,48);
u8g.drawLine(96,38,96,48);
u8g.drawStr(102, 48, "Faster");


u8g.drawLine(92,57,100,57);
u8g.drawLine(92,58,100,58);
u8g.drawStr(102, 63, "Slower");


}



void menu(void){
int last_tps_left;
int last_tps_right;
  if (digitalRead(Stop)){
          switch (draw_state){
            case 1 : draw_state = 2;
            break;            
            case 2 : draw_state = 1;
            break;   
            case 3 : draw_state = 1;         
            default :
            break;
          }
      }
    
  
  if ((digitalRead(Play))){
    draw_state = 3;
    Relay_1_Current = Left_Speed;
    Relay_2_Current = Right_Speed;
   
  }
  last_tps_left = TPS(Left_Speed);
  last_tps_right = TPS(Right_Speed);
  if (digitalRead(Plus)){
          switch (draw_state){
            case 1 : do{

                        Left_Speed += 1;}
                        while ((Left_Speed < 12468)&&(TPS(Left_Speed) == last_tps_left));
            break;            
            case 2 : do {
                        Right_Speed += 1;}
                        while ((Right_Speed < 12468)&&(TPS(Left_Speed) == last_tps_right));
            break;            

          }    
  }
  if (digitalRead(Minus)){
    Relay_1_Current = 10;
            switch (draw_state){
            case 1 : do{
                    if (Left_Speed>1)
                        Left_Speed -= 1;}
                        while((Left_Speed >1)&&(TPS(Left_Speed) == last_tps_right));
            break;            
            case 2 : do {
                      if (Right_Speed>1)
                        Right_Speed -= 1;}
                        while((Right_Speed>1)&&(TPS(Left_Speed) == last_tps_right));
            break;            
            default :
            break;
          }  
  }

  }

void setup(void) {

  // flip screen, if required
  //u8g.setRot180();

  pinMode(Relay_1, OUTPUT);
  pinMode(Relay_2, OUTPUT);
  pinMode(PowerPlus, OUTPUT);           
  digitalWrite(PowerPlus, HIGH); 
   
  pinMode (Stop, INPUT);
  pinMode (Plus, INPUT);
  pinMode (Minus, INPUT);
  pinMode (Play, INPUT);
  pinMode(in1, OUTPUT);
  digitalWrite(in1, HIGH);    
  pinMode(in2, OUTPUT);
  digitalWrite(in2, HIGH);


  
}

void loop(void) {


    
  // picture loop  
  u8g.firstPage();  
  do {
    draw();
    if (draw_state == 3){
  if (Left_Speed>0){
  Relay_1_Current -= 1;
  if (Relay_1_Current == 0){
      Relay_1_State = 1 - Relay_1_State;
      if (Relay_1_State == 1)
        Relay_1_Current = Relay_1_Press_Time;
        else Relay_1_Current = Left_Speed;
      }
  }
  if (Right_Speed >0){
  Relay_2_Current -= 1;
  if (Relay_2_Current == 0){
      Relay_2_State = 1 - Relay_2_State;
      if (Relay_2_State == 1)
        Relay_2_Current = Relay_2_Press_Time;
        else Relay_2_Current = Right_Speed;
      }
  }
      
  digitalWrite(in1, Relay_1_State);
  digitalWrite(in2, Relay_2_State);
  
}
  } while( u8g.nextPage() );
  
  if (LogoTimer < 25){
      LogoTimer ++;
      if (LogoTimer == 25)
          draw_state = 1;
      }
      
  //if (Timer < 25)
   //   Timer += 1;   
  //if (Timer > 74)
   //    Timer = 25;

  //if (Timer == 25){
   //    draw_state = 1;
    //   Timer = 26;
 // }



/*
 *         
 *     
 *     Relay_1_State = 1 - Relay_1_State;
       Relay_2_State = 1 - Relay_2_State;
       digitalWrite(Relay_1, HIGH);
       digitalWrite(Relay_2, HIGH);

 * 
 * 
 */
      
  // rebuild the picture after some delay
  menu();

}
